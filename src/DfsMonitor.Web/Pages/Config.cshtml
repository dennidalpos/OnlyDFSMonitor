@page
@model DfsMonitor.Web.Pages.ConfigModel

<html>
<head>
  <title>DFS Monitor Config</title>
  <style>
    body{font-family:Arial;margin:1.5rem;max-width:1200px}
    textarea{width:100%;height:18vh}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:.6rem 1.2rem}
    label{display:flex;justify-content:space-between;gap:.8rem;align-items:center}
    input[type='text'],input[type='number']{flex:1}
    .actions{margin-top:1rem}
  </style>
</head>
<body>
<h1>Configuration</h1>

<h3>Collection</h3>
<div class="grid">
  <label>Polling seconds <input id="poll" type="number"/></label>
  <label>Timeout seconds <input id="timeout" type="number"/></label>
  <label>Retry count <input id="retry" type="number"/></label>
  <label>Max parallelism <input id="parallel" type="number"/></label>
  <label>Event sample count <input id="eventSample" type="number"/></label>
</div>

<h3>Thresholds</h3>
<div class="grid">
  <label>Warn unreachable targets <input id="warnUnreach" type="number"/></label>
  <label>Critical unreachable targets <input id="critUnreach" type="number"/></label>
  <label>Warn backlog <input id="warnBacklog" type="number"/></label>
  <label>Critical backlog <input id="critBacklog" type="number"/></label>
</div>

<h3>Collectors</h3>
<p>
  <label><input id="dfsn" type="checkbox"/> DFS-N</label>
  <label><input id="dfsr" type="checkbox"/> DFS-R</label>
  <label><input id="ev" type="checkbox"/> EventLog</label>
</p>

<h3>Storage</h3>
<p>
  <label>Config UNC <input id="cfgPath" style="width:45rem"/></label><br/>
  <label>Status UNC root <input id="statusPath" style="width:45rem"/></label><br/>
  <label>Local cache root <input id="cachePath" style="width:45rem"/></label><br/>
  <label>Runtime state path <input id="runtimePath" style="width:45rem"/></label><br/>
  <label>Command queue path <input id="queuePath" style="width:45rem"/></label>
</p>

<h3>DFS-R Groups</h3>
<p><label><input id="autoDfsr" type="checkbox"/> Auto discover groups</label></p>
<textarea id="dfsrGroups" placeholder="One group name per line"></textarea>

<h3>Namespaces (one UNC path per line)</h3>
<textarea id="namespaces"></textarea>

<h3>Raw JSON (advanced)</h3>
<textarea id="raw"></textarea>


<h3>Installazione servizio Windows</h3>
<div class="grid">
  <label>Service name <input id="svcName" type="text"/></label>
  <label>Display name <input id="svcDisplay" type="text" value="DFS Monitor Service"/></label>
  <label style="grid-column:1 / span 2">Service executable path <input id="svcExe" type="text"/></label>
</div>

<h3>Parametri Web Server</h3>
<div class="grid">
  <label style="grid-column:1 / span 2">Web URLs (ASPNETCORE_URLS) <input id="webUrls" type="text"/></label>
  <label>Auth mode <input id="authMode" type="text"/></label>
  <label>JWT issuer <input id="jwtIssuer" type="text"/></label>
  <label>JWT audience <input id="jwtAudience" type="text"/></label>
  <label style="grid-column:1 / span 2">JWT signing key <input id="jwtKey" type="text"/></label>
</div>
<p>
  <button onclick="saveInstallOptions()">Save web/server settings</button>
  <button onclick="installService()">Install Windows service</button>
</p>

<div class="actions">
  <button onclick="save()">Save</button>
  <button onclick="reloadConfig()">Reload</button>
  <a href="/">Back</a>
</div>

<script>
let current;
function splitLines(value){return value.split('\n').map(x=>x.trim()).filter(Boolean)}

async function reloadConfig(){
  await reloadInstallOptions();
  const r=await fetch('/api/config');
  current = await r.json();
  document.getElementById('poll').value = current.collection.pollingIntervalSeconds;
  document.getElementById('timeout').value = current.collection.requestTimeoutSeconds;
  document.getElementById('retry').value = current.collection.retryCount;
  document.getElementById('parallel').value = current.collection.maxParallelism;
  document.getElementById('eventSample').value = current.collection.eventLogSampleCount;

  document.getElementById('warnUnreach').value = current.collection.thresholds.warnUnreachableTargets;
  document.getElementById('critUnreach').value = current.collection.thresholds.criticalUnreachableTargets;
  document.getElementById('warnBacklog').value = current.collection.thresholds.warnBacklog;
  document.getElementById('critBacklog').value = current.collection.thresholds.criticalBacklog;

  document.getElementById('dfsn').checked = current.collectors.dfsNamespace;
  document.getElementById('dfsr').checked = current.collectors.dfsReplication;
  document.getElementById('ev').checked = current.collectors.eventLog;

  document.getElementById('cfgPath').value = current.storage.configUncPath;
  document.getElementById('statusPath').value = current.storage.statusUncRootPath;
  document.getElementById('cachePath').value = current.storage.localCacheRootPath;
  document.getElementById('runtimePath').value = current.storage.runtimeStatePath;
  document.getElementById('queuePath').value = current.storage.commandQueuePath;

  document.getElementById('autoDfsr').checked = current.dfsr.autoDiscoverGroups;
  document.getElementById('dfsrGroups').value = (current.dfsr.replicationGroups||[]).join('\n');
  document.getElementById('namespaces').value = (current.namespaces||[]).map(n=>n.path).join('\n');
  document.getElementById('raw').value = JSON.stringify(current,null,2);
}

async function save(){
  const parsed = JSON.parse(document.getElementById('raw').value);

  parsed.collection.pollingIntervalSeconds = Number(document.getElementById('poll').value);
  parsed.collection.requestTimeoutSeconds = Number(document.getElementById('timeout').value);
  parsed.collection.retryCount = Number(document.getElementById('retry').value);
  parsed.collection.maxParallelism = Number(document.getElementById('parallel').value);
  parsed.collection.eventLogSampleCount = Number(document.getElementById('eventSample').value);

  parsed.collection.thresholds.warnUnreachableTargets = Number(document.getElementById('warnUnreach').value);
  parsed.collection.thresholds.criticalUnreachableTargets = Number(document.getElementById('critUnreach').value);
  parsed.collection.thresholds.warnBacklog = Number(document.getElementById('warnBacklog').value);
  parsed.collection.thresholds.criticalBacklog = Number(document.getElementById('critBacklog').value);

  parsed.collectors.dfsNamespace = document.getElementById('dfsn').checked;
  parsed.collectors.dfsReplication = document.getElementById('dfsr').checked;
  parsed.collectors.eventLog = document.getElementById('ev').checked;

  parsed.storage.configUncPath = document.getElementById('cfgPath').value;
  parsed.storage.statusUncRootPath = document.getElementById('statusPath').value;
  parsed.storage.localCacheRootPath = document.getElementById('cachePath').value;
  parsed.storage.runtimeStatePath = document.getElementById('runtimePath').value;
  parsed.storage.commandQueuePath = document.getElementById('queuePath').value;

  parsed.dfsr.autoDiscoverGroups = document.getElementById('autoDfsr').checked;
  parsed.dfsr.replicationGroups = splitLines(document.getElementById('dfsrGroups').value);

  parsed.namespaces = splitLines(document.getElementById('namespaces').value).map((path,ix)=>({id:`ui-${ix}-${Date.now()}`,path,enabled:true}));

  const r = await fetch('/api/config',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(parsed)});
  alert(r.ok?'Saved':'Save failed');
  if(r.ok) reloadConfig();
}


async function reloadInstallOptions(){
  const r = await fetch('/api/service/install/options');
  if(!r.ok){ return; }
  const opts = await r.json();
  document.getElementById('svcName').value = opts.serviceName || 'DfsMonitor.Service';
  document.getElementById('svcExe').value = opts.serviceExePath || 'C:\\DfsMonitor\\DfsMonitor.Service.exe';
  document.getElementById('webUrls').value = opts.webUrls || 'http://localhost:5000';
  document.getElementById('authMode').value = opts.authMode || 'Negotiate';
  document.getElementById('jwtIssuer').value = opts.jwtIssuer || 'dfs-monitor';
  document.getElementById('jwtAudience').value = opts.jwtAudience || 'dfs-monitor-api';
  document.getElementById('jwtKey').value = opts.jwtSigningKey || '';
}

async function saveInstallOptions(){
  const payload = {
    serviceName: document.getElementById('svcName').value.trim(),
    serviceExePath: document.getElementById('svcExe').value.trim(),
    webUrls: document.getElementById('webUrls').value.trim(),
    authMode: document.getElementById('authMode').value.trim(),
    jwtIssuer: document.getElementById('jwtIssuer').value.trim(),
    jwtAudience: document.getElementById('jwtAudience').value.trim(),
    jwtSigningKey: document.getElementById('jwtKey').value
  };

  const r = await fetch('/api/service/install/options',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
  alert(r.ok ? 'Impostazioni salvate' : 'Salvataggio fallito');
}

async function installService(){
  const payload = {
    serviceName: document.getElementById('svcName').value.trim(),
    serviceExePath: document.getElementById('svcExe').value.trim(),
    displayName: document.getElementById('svcDisplay').value.trim() || 'DFS Monitor Service'
  };

  const r = await fetch('/api/service/install',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
  if(r.ok){
    alert('Servizio installato e avviato');
    return;
  }

  const err = await r.text();
  alert('Installazione fallita: ' + err);
}

reloadConfig();
</script>
</body>
</html>
